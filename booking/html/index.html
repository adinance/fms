<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meeting Room Booking</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/buttons/3.0.0/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/2.1.4/css/dataTables.bootstrap5.min.css" rel="stylesheet" />

    <link href="booking.css" rel="stylesheet" /> 
</head>

<body class="p-0 light-mode">

    <!-- <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm py-0 border-bottom"> -->
    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light shadow-sm py-0 border-bottom">
        <div class="container-fluid">

            <a class="navbar-brand py-2 me-4 d-flex align-items-center" href="#">
                <img src="images/logo-black.png" alt="CMO Logo" class="me-1 rounded d-none d-md-block dark-mode-logo"
                    width="48px">
                <img src="images/logo-white.png" alt="CMO Logo" class="me-1 rounded light-mode-logo d-none d-md-block"
                    width="48px">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                    </li>
                </ul>

                <ul class="navbar-nav">

                    <li class="nav-item dropdown ms-2">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle"></i> <span class="d-lg-none d-xl-inline"> User A</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li>
                                <a class="dropdown-item" href="#" id="nav-profile-theme">
                                    <i class="bi bi-moon me-2" id="profileThemeIcon"></i>
                                    <span>Switch to Dark Mode</span>
                                </a>
                            </li>
                            <li><a class="dropdown-item" href="#">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="mainLayout" class="d-flex flex-fill">

        <div id="sidebarMenu" class="d-flex flex-column flex-shrink-0 bg-light border-end p-2 collapsed">

            <a class="h6 mt-2 mb-1 pb-1 collapsed-toggle" data-bs-toggle="collapse" href="#carMenu" role="button"
                aria-expanded="true" aria-controls="carMenu">
                <i class="bi bi-car-front me-1 "></i>
                <span>Car Center</span>
            </a>

            <ul id="carMenu" class="nav nav-pills flex-column collapse show">
                <li class="nav-item"><a id="menu-car-center" href="#" class="nav-link"><i class="bi bi-ev-front"></i>
                        <span>All Booking</span></a></li>
                <li class="nav-item"><a id="menu-car-reserve" href="#" class="nav-link"><i
                            class="bi bi-ev-front-fill"></i>
                        <span>My Booking</span></a></li>
            </ul>

            <a class="h6 mt-1 mb-1 pb-1 collapsed-toggle" data-bs-toggle="collapse" href="#meetingMenu" role="button"
                aria-expanded="true" aria-controls="meetingMenu">
                <i class="bi bi-easel me-1 "></i>
                <span>Meeting Room</span>
            </a>

            <ul id="meetingMenu" class="nav nav-pills flex-column mb-auto collapse show">
                <li class="nav-item"><a id="menu-meeting-room" href="#" class="nav-link">
                        <i class="bi bi-calendar-week"></i><span>All Booking</span></a></li>
                <li class="nav-item">
                    <a id="menu-meeting-calendar" href="#" class="nav-link active" aria-current="page">
                        <i class="bi bi-calendar-check-fill"></i><span>My Booking</span></a>
                </li>
            </ul>

            <div class="mt-auto border-top p-2 text-center">
                <button id="sidebarToggle" class="btn btn-sm w-100 p-0 shadow-none">
                    <i class="bi bi-arrow-right-circle-fill"></i>
                </button>
            </div>

        </div>

        <div id="mainContent" class="flex-grow-1 p-3">
            <div class="container" id="contentContainer">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card shadow-lg mt-4">
                            <div class="card-header">Main Calendar</div>
                            <div class="card-body pt-4 pb-5 ">
                                <div id="calendar"></div>
                            </div>
                            <div class="card-footer">* ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà Hiligh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠
                                ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°
                                + ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card shadow mt-4">
                            <div class="card-header text-end">Mini Calendar</div>
                            <div class="card-body pt-0 ">
                                <div id="miniCalendar"></div>
                            </div>
                        </div>

                        <div class="card shadow mt-3">
                            <div class="card-body py-3">
                                <div class="row gx-0">
                                    <div class="col-sm-4">
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input room-filter"
                                                id="filter_room_1" value="Meeting 1" checked>
                                            <label class="form-check-label" for="filter_room_1"
                                                style="white-space: nowrap;"> Meeting 1</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input room-filter"
                                                id="filter_room_2" value="Meeting 2" checked>
                                            <label class="form-check-label" for="filter_room_2"
                                                style="white-space: nowrap;"> Meeting 2</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input room-filter"
                                                id="filter_room_3" value="Meeting 3" checked>
                                            <label class="form-check-label" for="filter_room_3"
                                                style="white-space: nowrap;"> Meeting 3</label>
                                        </div>
                                    </div>
                                    <div class="col-sm-8">
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input room-filter"
                                                id="filter_room_4" value="Training Room 1 (Floor 3)" checked>
                                            <label class="form-check-label" for="filter_room_4"
                                                style="white-space: nowrap;"> Training Room 1 (Floor 3)</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input room-filter"
                                                id="filter_room_5" value="Training Room 3 (Floor 1)" checked>
                                            <label class="form-check-label" for="filter_room_5"
                                                style="white-space: nowrap;"> Training Room 3 (Floor 1)</label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input type="checkbox" class="form-check-input room-filter"
                                                id="filter_room_6" value="‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏π‡∏ô (Floor 3)" checked>
                                            <label class="form-check-label" for="filter_room_6"
                                                style="white-space: nowrap;"> ‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏π‡∏ô (Floor 3)</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-end">Select room to display</div>
                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="col-md-12">

                        <div class="card p-3 mt-5 shadow" id="tableWrapper">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5>üìã Booking List</h5>
                            </div>

                            <div>
                                <table id="bookingTable" class="table table-bordered table-striped">
                                    <thead>
                                        <tr>
                                            <th>Room</th>
                                            <th>Title</th>
                                            <th>Start</th>
                                            <th>End</th>
                                            <th>Booking Name</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <button id="toggleTable" class="fab"><i class="bi bi-table"></i></button>

            <button class="fab fab-add-new" data-bs-toggle="modal" data-bs-target="#bookingModal">
                <i class="bi bi-plus"></i>
            </button>

        </div>
    </div>

    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <form id="bookingForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Booking Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-2">
                        <label>Title</label>
                        <input type="text" name="title" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <label>Room</label>
                        <select name="room" class="form-select" required>
                            <option value="Meeting 1">Meeting 1</option>
                            <option value="Meeting 2">Meeting 2</option>
                            <option value="Meeting 3">Meeting 3</option>
                            <option value="Training Room 1 (Floor 3)">Training Room 1 (Floor 3)</option>
                            <option value="Training Room 3 (Floor 1)">Training Room 3 (Floor 1)</option>
                            <option value="‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏π‡∏ô (Floor 3)">Poon Room (Floor 3)</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>Subject</label>
                        <input type="text" name="subject" class="form-control" required />
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Start Date</label>
                            <input type="text" id="start_time" name="start" class="form-control" required />
                        </div>
                        <div class="col">
                            <label>End Date</label>
                            <input type="text" id="end_time" name="end" class="form-control" required />
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>Booked By</label>
                        <input type="text" name="booked_by" class="form-control" required />
                    </div>
                    <div class="mt-2">
                        <label>Note</label>
                        <textarea name="note" class="form-control" rows="2"></textarea>
                    </div>
                </div>
                <!-- <div class="modal-body">
                    <div class="mb-2">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (Title)</label>
                        <input type="text" name="title" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <label>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° (Room)</label>
                        <select name="room" class="form-select" required>
                            <option value="Meeting 1">Meeting 1</option>
                            <option value="Meeting 2">Meeting 2</option>
                            <option value="Meeting 3">Meeting 3</option>
                            <option value="Training Room 1 (Floor 3)">Training Room 1 (Floor 3)</option>
                            <option value="Training Room 3 (Floor 1)">Training Room 3 (Floor 1)</option>
                            <option value="‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏π‡∏ô (Floor 3)">‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏π‡∏ô (Floor 3)</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Subject)</label>
                        <input type="text" name="subject" class="form-control" required />
                    </div>
                    <div class="mb-2">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</label>
                        <input type="text" id="meeting_date" name="meeting_date" class="form-control" required />
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏° (Start)</label>
                            <input type="text" id="start_time" name="start_time" class="form-control" required />
                        </div>
                        <div class="col">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (End)</label>
                            <input type="text" id="end_time" name="end_time" class="form-control" required />
                        </div>
                    </div>
                    <div class="mt-2">
                        <label>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Booked By)</label>
                        <input type="text" name="booked_by" class="form-control" required />
                    </div>
                    <div class="mt-2">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Note)</label>
                        <textarea name="note" class="form-control" rows="2"></textarea>
                    </div>
                </div> -->
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <footer id="mainFooter" class="border-top py-2 px-3 text-center">
        <div class="container-fluid">
            <span class="text-muted">
                &copy; <span id="currentYear"></span> CMO PUBLIC COMPANY LIMITED. All rights reserved.
                <span class="d-none d-md-inline">| Last access: <span id="currentTime"></span></span>
            </span>
        </div>
    </footer>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><b>‡∏´‡πâ‡∏≠‡∏á:</b> <span id="d_room"></span></div>
                    <div class="mb-2"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:</b> <span id="d_title"></span></div>
                    <div class="mb-2"><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</b> <span id="d_subject"></span></div>
                    <div class="mb-2"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="d_date"></span></div>
                    <div class="mb-2"><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> <span id="d_time_range"></span></div>
                    <div class="mb-2"><b>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> <span id="d_booked"></span></div>
                    <div class="mb-2"><b>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö:</b> <span id="d_booked_time"></span></div>
                    <div class="mb-2"><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> <span id="d_note"></span></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.0/js/buttons.excelHtml5.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const roomColors = {
                "Meeting 1": "#0d6efd",
                "Meeting 2": "#198754",
                "Meeting 3": "#fd7e14",
                "Training Room 1 (Floor 3)": "#6f42c1",
                "Training Room 3 (Floor 1)": "#dc3545",
                "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏π‡∏ô (Floor 3)": "#20c997"
            };
            let darkMode = localStorage.getItem("darkMode") === "true";
            let isTableVisible = localStorage.getItem("isTableVisible") !== "false";
            let isSidebarCollapsed = localStorage.getItem("isSidebarCollapsed") === "true";
            const ACTIVE_MENU_KEY = 'activeMenuId';
            const NAVBAR_ACTIVE_KEY = 'navbarActiveId';
            const CAR_MENU_STATE = 'carMenuState';
            const MEETING_MENU_STATE = 'meetingMenuState';
            let calendar, miniCal, table;
            const DATA_URL = "data.json";
            // üö© Initializations
            initTheme();
            initSidebar();
            loadCollapseMenuState();
            initActiveMenu();
            initNavbarActiveMenu();
            initPickers();
            initCalendars();
            initTable();
            initEventHandlers();
            const getStartDay = (datetime) => datetime ? datetime.substring(0, 10) : "";

            function initNavbarActiveMenu() {
                const defaultNavbarId = 'nav-report-current-year';
                let activeNavbarId = localStorage.getItem(NAVBAR_ACTIVE_KEY) || defaultNavbarId;
                $('.navbar-nav .nav-link, .navbar-nav .dropdown-item').removeClass('active');
                if (activeNavbarId) {
                    const activeLink = $(`#${activeNavbarId}`);
                    if (activeLink.length) {
                        activeLink.addClass('active');
                        const parentDropdownToggle = activeLink.closest('.dropdown').find('.dropdown-toggle')
                            .first();
                        if (parentDropdownToggle.length) {
                            parentDropdownToggle.addClass('active');
                        }
                        const dropendToggle = activeLink.closest('.dropend').find(
                            '.dropdown-item.dropdown-toggle');
                        if (dropendToggle.length) {
                            dropendToggle.addClass('active');
                        }
                    }
                }
            }

            function initActiveMenu() {
                const defaultMenuId = "menu-meeting-calendar";
                let activeMenuId = localStorage.getItem(ACTIVE_MENU_KEY) || defaultMenuId;
                $("#sidebarMenu .nav-link").removeClass("active").removeAttr("aria-current");
                const activeLink = $(`#${activeMenuId}`);
                if (activeLink.length) {
                    activeLink.addClass("active").attr("aria-current", "page");
                } else {
                    $(`#${defaultMenuId}`).addClass("active").attr("aria-current", "page");
                    localStorage.setItem(ACTIVE_MENU_KEY, defaultMenuId);
                }
            }

            function initSidebar() {
                applySidebarState(isSidebarCollapsed);
                // **‡∏•‡∏ö** ‡πÇ‡∏Ñ‡πâ‡∏î jQuery ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ <span> ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å HTML ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
                // $("#sidebarMenu .nav-link").each(function() { ... });
            }

            function applySidebarState(isCollapsed) {
                const sidebar = document.getElementById("sidebarMenu");
                const toggleIcon = document.querySelector("#sidebarToggle i");
                const contentContainer = document.getElementById("contentContainer");
                if (isCollapsed) {
                    sidebar.classList.add("collapsed");
                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡∏∏‡∏ö: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏£‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ (bi-arrow-right-circle-fill) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î
                    toggleIcon.classList.remove("bi-arrow-left-circle-fill");
                    toggleIcon.classList.add("bi-arrow-right-circle-fill");
                    contentContainer.classList.remove("container");
                    contentContainer.classList.add("container-fluid");
                } else {
                    sidebar.classList.remove("collapsed");
                    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢: ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏£‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (bi-arrow-left-circle-fill) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
                    toggleIcon.classList.remove("bi-arrow-right-circle-fill");
                    toggleIcon.classList.add("bi-arrow-left-circle-fill");
                    contentContainer.classList.remove("container-fluid");
                    contentContainer.classList.add("container");
                }
            }

            function loadCollapseMenuState() {
                const carState = localStorage.getItem(CAR_MENU_STATE);
                const meetingState = localStorage.getItem(MEETING_MENU_STATE);
                const setMenuState = (menuId, savedState) => {
                    const menu = $(`#${menuId}`);
                    const toggle = $(`a[href="#${menuId}"]`);
                    if (savedState === 'false') {
                        menu.removeClass('show');
                        toggle.addClass('collapsed');
                        toggle.attr('aria-expanded', 'false');
                    } else if (savedState === 'true') {
                        menu.addClass('show');
                        toggle.removeClass('collapsed');
                        toggle.attr('aria-expanded', 'true');
                    } else {
                        menu.addClass('show');
                        toggle.removeClass('collapsed');
                        toggle.attr('aria-expanded', 'true');
                    }
                };
                setMenuState('carMenu', carState);
                setMenuState('meetingMenu', meetingState);
            }

            function saveRoomFilterState() {
                const roomStates = {};
                $(".room-filter").each(function() {
                    roomStates[$(this).val()] = $(this).is(":checked");
                });
                localStorage.setItem("roomFilterStates", JSON.stringify(roomStates));
            }

            function loadRoomFilterState() {
                const savedRoomStates = localStorage.getItem("roomFilterStates");
                let selectedRooms = [];
                let shouldSaveDefaultState = false;
                if (savedRoomStates) {
                    try {
                        const roomStates = JSON.parse(savedRoomStates);
                        $(".room-filter").each(function() {
                            const roomName = $(this).val();
                            const isChecked = roomStates.hasOwnProperty(roomName) ? roomStates[
                                roomName] : true;
                            $(this).prop("checked", isChecked);
                            if (isChecked) {
                                selectedRooms.push(roomName);
                            }
                        });
                    } catch (e) {
                        console.error("Error parsing room filter states from Local Storage:", e);
                        localStorage.removeItem("roomFilterStates");
                        shouldSaveDefaultState = true;
                    }
                }
                if (!savedRoomStates || shouldSaveDefaultState) {
                    $(".room-filter").prop("checked", true);
                    selectedRooms = $(".room-filter").map(function() {
                        return this.value;
                    }).get();
                    saveRoomFilterState();
                }
                return selectedRooms;
            }

            function initTheme() {
                applyTheme(darkMode);
            }

            function applyTheme(isDark) {
                const body = document.body;
                const profileThemeIcon = document.getElementById("profileThemeIcon");
                const profileThemeText = document.querySelector("#nav-profile-theme span");
                if (isDark) {
                    body.classList.add("dark-mode");
                    body.classList.remove("light-mode");
                    $('.light-mode-logo').css('display', 'none');
                    $('.dark-mode-logo').css('display', 'inline-block');
                    if (profileThemeIcon) profileThemeIcon.className = "bi bi-sun me-2";
                    if (profileThemeText) profileThemeText.textContent = "Switch to Light Mode";
                } else {
                    body.classList.add("light-mode");
                    body.classList.remove("dark-mode");
                    $('.dark-mode-logo').css('display', 'none');
                    $('.light-mode-logo').css('display', 'inline-block');
                    if (profileThemeIcon) profileThemeIcon.className = "bi bi-moon me-2";
                    if (profileThemeText) profileThemeText.textContent = "Switch to Dark Mode";
                }
            }

            function applyTableVisibility(isVisible) {
                const tableWrapper = $("#tableWrapper");
                const icon = $('#toggleTable i');
                if (isVisible) {
                    tableWrapper.show();
                    icon.removeClass("bi-eye-slash").addClass("bi-table");
                } else {
                    tableWrapper.hide();
                    icon.removeClass("bi-table").addClass("bi-eye-slash");
                }
            }

            function initPickers() {
                // ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°' ‡πÅ‡∏•‡∏∞ '‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î' ‡πÅ‡∏ó‡∏ô
                const flatpickrConfig = {
                    enableTime: true,
                    // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD HH:MM:SS
                    dateFormat: "Y-m-d H:i",
                    // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
                    noCalendar: false,
                    time_24hr: true,
                    onOpen: (selectedDates, dateStr, instance) => {
                        if (document.body.classList.contains('dark-mode')) {
                            instance.calendarContainer.classList.add('dark-mode');
                        } else {
                            instance.calendarContainer.classList.remove('dark-mode');
                        }
                    }
                };
                // ‡πÉ‡∏ä‡πâ config ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Start Time
                flatpickr("#start_time", flatpickrConfig);
                // ‡πÉ‡∏ä‡πâ config ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö End Time
                flatpickr("#end_time", flatpickrConfig);
            }
            // const formatTime = (datetime) => datetime ? datetime.substring(11) : "-";
            // function initPickers() {
            //     flatpickr("#meeting_date", {
            //         dateFormat: "Y-m-d",
            //         onOpen: (selectedDates, dateStr, instance) => {
            //             if (document.body.classList.contains('dark-mode')) {
            //                 instance.calendarContainer.classList.add('dark-mode');
            //             } else {
            //                 instance.calendarContainer.classList.remove('dark-mode');
            //             }
            //         }
            //     });
            //     flatpickr("#start_time", {
            //         enableTime: true,
            //         noCalendar: true,
            //         dateFormat: "H:i:s",
            //         onOpen: (selectedDates, dateStr, instance) => {
            //             if (document.body.classList.contains('dark-mode')) {
            //                 instance.calendarContainer.classList.add('dark-mode');
            //             } else {
            //                 instance.calendarContainer.classList.remove('dark-mode');
            //             }
            //         }
            //     });
            //     flatpickr("#end_time", {
            //         enableTime: true,
            //         noCalendar: true,
            //         dateFormat: "H:i:s",
            //         onOpen: (selectedDates, dateStr, instance) => {
            //             if (document.body.classList.contains('dark-mode')) {
            //                 instance.calendarContainer.classList.add('dark-mode');
            //             } else {
            //                 instance.calendarContainer.classList.remove('dark-mode');
            //             }
            //         }
            //     });
            // }
            function mapEventData(e) {
                const isAllDay = !e.start.includes('T') && !e.end.includes('T');
                return {
                    id: e.id,
                    title: e.title + " (" + e.room + ")",
                    start: e.start,
                    end: e.end,
                    extendedProps: e,
                    color: roomColors[e.room],
                    allDay: isAllDay,
                    display: 'auto',
                    startEditable: false,
                    durationEditable: false
                };
            }

            function showEventDetails(info) {
                let data = info.event.extendedProps;
                const formatTime = (datetime) => datetime ? datetime.substring(11).substring(0, 5) :
                    "-";
                const startDate = getStartDay(data.start);
                const startTime = formatTime(data.start);
                const endDate = getStartDay(data.end);
                const endTime = formatTime(data.end);
                const isMultiDay = (startDate !== endDate);
                let dateDisplay, timeDisplay;
                if (isMultiDay) {
                    dateDisplay = `${startDate} ‡∏ñ‡∏∂‡∏á ${endDate}`;
                    timeDisplay = `${startTime} - ${endTime}`;
                } else {
                    dateDisplay = startDate;
                    timeDisplay = `${startTime} - ${endTime}`;
                }
                const modalBody = document.querySelector("#detailModal .modal-body");
                modalBody.innerHTML = `
            <div class="mb-2"><b>‡∏´‡πâ‡∏≠‡∏á:</b> <span id="d_room">${data.room || "-"}</span></div>
            <div class="mb-2"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°:</b> <span id="d_title">${data.title.replace(` (${data.room})`, '') || "-"}</span></div>
            <div class="mb-2"><b>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠:</b> <span id="d_subject">${data.subject || "-"}</span></div>
            <div class="mb-2"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="d_date">${dateDisplay}</span></div>
            <div class="mb-2"><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> <span id="d_time_range">${timeDisplay}</span></div>
            <div class="mb-2"><b>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</b> <span id="d_booked">${data.booked_by || "-"}</span></div>
            <div class="mb-2"><b>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö:</b> <span id="d_booked_time">${data.booked_time || "-"}</span></div>
            <div class="mb-2"><b>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</b> <span id="d_note">${data.note || "-"}</span></div> `;
                new bootstrap.Modal(document.getElementById("detailModal")).show();
            }

            function initCalendars() {
                const initialRooms = loadRoomFilterState();
                const eventSourceConfig = {
                    url: DATA_URL,
                    method: 'GET',
                    failure: function() {
                        console.error("Failed to fetch events from data.json");
                    },
                    success: function(rawEvents) {
                        const events = rawEvents.map(mapEventData);
                        const selectedRooms = initialRooms.length > 0 ? initialRooms : $(
                            ".room-filter:checked").map(function() {
                            return this.value;
                        }).get();
                        return events.map(evt => {
                            const isVisible = selectedRooms.includes(evt.extendedProps.room);
                            evt.display = isVisible ? "auto" : "none";
                            return evt;
                        });
                    }
                };
                const isMobile = window.matchMedia("(max-width: 768px)").matches;
                const mainHeaderToolbar = isMobile ? {
                    left: "prev,next",
                    right: "dayGridMonth,timeGridWeek,timeGridDay,listMonth,multiMonthYear"
                } : {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay,listMonth,multiMonthYear"
                };
                calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                    themeSystem: 'bootstrap5',
                    initialView: "dayGridMonth",
                    height: "auto",
                    headerToolbar: mainHeaderToolbar,
                    buttonText: {
                        today: "Today",
                        month: "Month",
                        week: "Week",
                        day: "Day",
                        listMonth: 'List',
                        multiMonthYear: 'Annual'
                    },
                    timeZone: 'local',
                    views: {
                        dayGridMonth: {
                            titleFormat: {
                                month: 'long'
                            }
                        },
                    },
                    events: eventSourceConfig,
                    eventClick: showEventDetails
                });
                const miniHeaderToolbar = isMobile ? {
                    left: "prev",
                    center: "title",
                    right: "next"
                } : {
                    left: "prev",
                    center: "title",
                    right: "next"
                };
                miniCal = new FullCalendar.Calendar(document.getElementById("miniCalendar"), {
                    initialView: "dayGridMonth",
                    height: "auto",
                    contentHeight: "auto",
                    expandRows: true,
                    headerToolbar: miniHeaderToolbar,
                    events: eventSourceConfig,
                    eventClick: showEventDetails,
                    selectable: true,
                    dateClick: info => calendar.gotoDate(info.dateStr)
                });
                calendar.render();
                miniCal.render();
            }

            function initTable() {
                const initialRooms = loadRoomFilterState();
                applyRoomFilter(false);
                table = $("#bookingTable").DataTable({
                    dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex align-items-center justify-content-end"fB>>' +
                        '<"row spacer-row">' +
                        '<"row"<"col-sm-12"t>>' +
                        '<"row spacer-row">' +
                        '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                    initComplete: function() {
                        $(this.api().table().container()).find('.dt-buttons').css({
                            'margin-left': '15px',
                            'margin-bottom': '0'
                        });
                        $(this.api().table().container()).find('.dataTables_filter').css({
                            'margin-right': '0',
                            'margin-bottom': '0'
                        });
                        // üö© Apply theme immediately after init
                        updateDatatableButtonTheme(darkMode);
                    },
                    buttons: [{
                            extend: 'copyHtml5',
                            text: '<i class="bi bi-files"></i>',
                            className: 'btn btn-light btn-sm',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                        {
                            extend: 'excelHtml5',
                            text: '<i class="bi bi-file-earmark-excel"></i>',
                            className: 'btn btn-light btn-sm',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                        {
                            extend: 'csvHtml5',
                            text: '<i class="bi bi-filetype-csv"></i>',
                            className: 'btn btn-light btn-sm',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                        {
                            extend: 'print',
                            text: '<i class="bi bi-printer"></i>',
                            className: 'btn btn-light btn-sm',
                            exportOptions: {
                                columns: ':visible'
                            }
                        }
                    ],
                    ajax: {
                        url: DATA_URL,
                        dataSrc: ""
                    },
                    columns: [{
                            data: "room"
                        },
                        {
                            data: "title"
                        },
                        {
                            data: "start",
                            render: function(data, type, row) {
                                return data.substring(0, 10);
                            }
                        },
                        {
                            data: "end",
                            render: function(data, type, row) {
                                const startTime = row.start.substring(11, 16);
                                const endTime = data.substring(11, 16);
                                return `${startTime} - ${endTime}`;
                            }
                        },
                        {
                            data: "booked_by"
                        }
                    ],
                    stateSave: true
                });
                applyTableVisibility(isTableVisible);
                table.on('init', function() {
                    let searchVal;
                    if (initialRooms.length === 0) {
                        searchVal = "^$";
                    } else {
                        const escapedRooms = initialRooms.map(room => {
                            return room.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        });
                        searchVal = "^(" + escapedRooms.join("|") + ")$";
                    }
                    table.column(0).search(searchVal, true, false).draw();
                });
                // üö© Apply theme on every draw (e.g., page change, sort)
                table.on('draw.dt', function() {
                    applyPaginationTheme(darkMode);
                });
            }

            function updateDatatableButtonTheme(isDark) {
                if (!table) return;
                const exportButtons = table.buttons().containers().find('.btn');
                if (isDark) {
                    exportButtons.removeClass('btn-light').addClass('btn-dark');
                } else {
                    exportButtons.removeClass('btn-dark').addClass('btn-light');
                }
                applyPaginationTheme(isDark);
            }

            function applyPaginationTheme(isDark) {
                if (!table) return;
                const paginateButtons = $(table.table().container()).find(
                    '.dataTables_paginate .paginate_button');
                paginateButtons.removeClass('btn-light btn-dark btn-sm');
                paginateButtons.addClass('btn btn-sm');
                if (isDark) {
                    paginateButtons.addClass('btn-dark');
                    // DataTables Bootstrap CSS handles the .current and .disabled state
                } else {
                    paginateButtons.addClass('btn-light');
                    // DataTables Bootstrap CSS handles the .current and .disabled state
                    // We ensure current button gets the primary look in light mode
                    paginateButtons.filter('.current').css({
                        'background-color': '#0d6efd',
                        'border-color': '#0d6efd',
                        'color': '#fff'
                    });
                }
                // Apply standard non-active styling (mainly for light mode border consistency)
                paginateButtons.not('.current').css({
                    'background-color': isDark ? '#2a2a2a' : 'transparent',
                    'border-color': isDark ? '#555' : '#dee2e6',
                    'color': isDark ? '#ddd' : '#0d6efd'
                });
                // Handle Disabled buttons (in-line override for better contrast in both themes)
                paginateButtons.filter('.disabled').css({
                    'background-color': isDark ? '#1f1f1f' : '#f8f9fa',
                    'border-color': isDark ? '#333' : '#dee2e6',
                    'color': isDark ? '#555' : '#ccc'
                });
            }

            function initEventHandlers() {
                $("#sidebarToggle").on("click", function() {
                    isSidebarCollapsed = !isSidebarCollapsed;
                    localStorage.setItem("isSidebarCollapsed", isSidebarCollapsed);
                    applySidebarState(isSidebarCollapsed);
                    setTimeout(() => {
                        calendar.updateSize();
                        miniCal.updateSize();
                    }, 300);
                });
                $("#nav-profile-theme").on("click", function(e) {
                    e.preventDefault();
                    darkMode = !darkMode;
                    localStorage.setItem("darkMode", darkMode);
                    applyTheme(darkMode);
                    // Update DataTable theme and redraw pagination immediately
                    updateDatatableButtonTheme(darkMode);
                    if (table) {
                        applyPaginationTheme(darkMode);
                    }
                });
                $('#carMenu').on('hidden.bs.collapse', function() {
                    localStorage.setItem(CAR_MENU_STATE, 'false');
                });
                $('#carMenu').on('shown.bs.collapse', function() {
                    localStorage.setItem(CAR_MENU_STATE, 'true');
                });
                $('#meetingMenu').on('hidden.bs.collapse', function() {
                    localStorage.setItem(MEETING_MENU_STATE, 'false');
                });
                $('#meetingMenu').on('shown.bs.collapse', function() {
                    localStorage.setItem(MEETING_MENU_STATE, 'true');
                });
                $("#sidebarMenu .nav-link").on("click", function(e) {
                    e.preventDefault();
                    $("#sidebarMenu .nav-link").removeClass("active").removeAttr("aria-current");
                    $(this).addClass("active").attr("aria-current", "page");
                    localStorage.setItem(ACTIVE_MENU_KEY, this.id);
                });
                $('.navbar-nav .dropdown-item').on('click', function(e) {
                    e.preventDefault();
                    const clickedId = $(this).attr('id');
                    $('.navbar-nav .nav-link, .navbar-nav .dropdown-item').removeClass('active');
                    $(this).addClass('active');
                    const parentDropdownToggle = $(this).closest('.dropdown').find('.dropdown-toggle')
                        .first();
                    parentDropdownToggle.addClass('active');
                    const dropendToggle = $(this).closest('.dropend').find(
                        '.dropdown-item.dropdown-toggle');
                    dropendToggle.addClass('active');
                    localStorage.setItem(NAVBAR_ACTIVE_KEY, clickedId);
                });
                // Dropdown Sub-menu on Hover (for desktop)
                $('.dropend').on('mouseenter', function() {
                    var $el = $(this);
                    var $menu = $el.find('.dropdown-menu');
                    $menu.addClass('show');
                    if ($menu.offset().left + $menu.width() > $(window).width()) {
                        $menu.removeClass('dropdown-menu-end').addClass('dropdown-menu-start');
                    }
                }).on('mouseleave', function() {
                    var $el = $(this);
                    var $menu = $el.find('.dropdown-menu');
                    $menu.removeClass('show');
                    $menu.removeClass('dropdown-menu-start').addClass('dropdown-menu-end');
                });
                $(".room-filter").on("change", function() {
                    applyRoomFilter(false);
                    filterDataTableByRooms();
                    saveRoomFilterState();
                });
                $("#bookingForm").on("submit", handleBookingSubmit);
                $("#toggleTable").on("click", function() {
                    const tableWrapper = $("#tableWrapper");
                    const newState = !tableWrapper.is(":visible");
                    applyTableVisibility(newState);
                    localStorage.setItem("isTableVisible", newState);
                    if (newState) {
                        table.draw(false);
                    }
                });
            }

            function filterDataTableByRooms() {
                let selectedRooms = $(".room-filter:checked").map(function() {
                    return this.value;
                }).get();
                let searchVal;
                if (selectedRooms.length === 0) {
                    searchVal = "^$";
                } else {
                    const escapedRooms = selectedRooms.map(room => {
                        return room.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    });
                    searchVal = "^(" + escapedRooms.join("|") + ")$";
                }
                table.column(0).search('');
                table.column(0).search(searchVal, true, false).draw();
            }

            function applyRoomFilter(updateTable = true) {
                let selectedRooms = $(".room-filter:checked").map(function() {
                    return this.value;
                }).get();
                const filterFunc = evt => selectedRooms.includes(evt.extendedProps.room) ? "auto" : "none";
                calendar.getEvents().forEach(evt => evt.setProp("display", filterFunc(evt)));
                miniCal.getEvents().forEach(evt => evt.setProp("display", filterFunc(evt)));
                if (updateTable) {
                    filterDataTableByRooms();
                }
            }

            function handleBookingSubmit(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const bookingData = Object.fromEntries(formData.entries());
                console.log("New Booking Data Submitted (Simulated):", bookingData);
                alert(`‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á "${bookingData.room}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Title: ${bookingData.title})`);
                bootstrap.Modal.getInstance(document.getElementById("bookingModal")).hide();
                $("#bookingForm")[0].reset();
                table.ajax.reload(function() {
                    calendar.refetchEvents();
                    miniCal.refetchEvents();
                    calendar.gotoDate(bookingData.meeting_date);
                    filterDataTableByRooms();
                }, false);
            }
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô Footer
            document.getElementById("currentYear").textContent = new Date().getFullYear();
            document.getElementById("currentTime").textContent = new Date().toLocaleTimeString('th-TH', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        });
    </script>
</body>

</html>